---
resources:
    # already fetched into git by cronjob at storage
    #
    - name: tpen-data-write
      type: git
      source:
        uri: {{tpen-data-uri}}
        branch: {{tpen-data-branch}}
        paths: [transcription]
        private_key: {{DHUniWienMU-priv-key}}

    - name: tpen-data-read
      type: git
      source:
        uri: {{tpen-data-uri}}
        branch: {{tpen-data-branch}}
        paths: [transcription]
        ignore_paths: [transcription/tei-xml, transcription/collatex-out]
        private_key: {{DHUniWienMU-priv-key}}

    - name: moe-data
      type: git
      source:
        uri: {{moe-data-uri}}
        branch: {{moe-data-branch}}
        paths: [ci/resources]

    - name: moe-config
      type: git
      source:
        uri: {{moe-config-uri}}
        private_key: {{DHUniWienMU-priv-key}}


    #- name: version
    #  type: semver
    #  source:
    #    driver: git
    #    uri: {{version-uri}}
    #    branch: {{version-branch}}
    #    file: {{version-file}}
    #    initial_version: "0.0.0"
    #    private_key: {{DHUniWienMU-priv-key}}

    - name: ssh-keys
      type: git
      source:
        uri: {{ssh-keys-uri}}
        private_key: {{DHUniWienMU-priv-key}}

    - name: netrc-test-api
      type: git
      source:
        uri: {{netrc-test-api-uri}}
        private_key: {{DHUniWienMU-priv-key}}

    - name: ci
      type: git
      source:
        uri: {{ci-uri}}


jobs:

    - name: tpen2tei
      plan:
        - aggregate:
          - get: tpen-data-read
            trigger: true
          - get: ssh-keys
          - get: moe-data

        - task: task-tpen2tei
          input_mapping: { tpen-data: tpen-data-read }

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]

            inputs:
              ### - name: tpen-data
              - name: moe-data
              - name: ssh-keys
            outputs:
              - name: tei-xml
              - name: tpen-data-bumped

            run:
              path: sh
              args:
                - -exc
                - |
                  chmod 600 ssh-keys/github/DHUniWienMU-id_rsa
                  export GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no -i ssh-keys/github/DHUniWienMU-id_rsa"

                  git clone {{tpen-data-uri}} tpen-data-bumped

                  cd tpen-data-bumped

                  ### use merged files
                  [ -d transcription/merged ] || mkdir transcription/merged/
                  python3 ../moe-data/ci/resources/merge-json.py transcription/ transcription/merged --verbose

                  ### create TEI-XML
                  [ -d transcription/tei-xml ] || mkdir transcription/tei-xml/
                  python3 ../moe-data/ci/resources/json2xml.py transcription/merged transcription/tei-xml/

                  # ### use files as they come from T-PEN
                  # [ -d transcription/tei-xml ] || mkdir transcription/tei-xml/
                  # python3 ../moe-data/ci/resources/json2xml.py transcription/ transcription/tei-xml/

                  git config --global user.email "ci@dh.gesch.univie.ac.at"
                  git config --global user.name "moe-data/tpen2tei"

                  cd transcription/tei-xml/
                  git add *xml

                  GIT_STATUS=`git status`

                  if echo $GIT_STATUS | grep -q "Changes to be committed:" -;
                  then
                      git commit -m "tpen2tei" *xml
                  fi

        - put: tpen-data-write
          params: {repository: tpen-data-bumped}

    - name: validate-tei-xml
      plan:
        - get: tpen-data-read
          trigger: true
          passed: [tpen2tei]

        - task: task-validate-tei-xml
          input_mapping: { tpen-data: tpen-data-read }

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]

            inputs:
              - name: tpen-data

            run:
              path: sh
              args:
                - -exc
                - |
                  SAVEIFS=$IFS
                  IFS=$(echo -en "\n\b")

                  # for now: don't care if a linter fails instead make sure
                  # all files are checked by swallowing the return value
                  #
                  sh -c '
                      for FILE in tpen-data/transcription/tei-xml/*xml
                      do
                          # xmlwf "$FILE" && \
                          xmllint --noout --relaxng "{{relaxng_schema}}" "$FILE"
                      done
                      exit 0
                  '

                  IFS=$SAVEIFS
                  exit 0

    - name: collate
      plan:
        - aggregate:
          - get: tpen-data-read
            trigger: true
            passed: [validate-tei-xml]
          - get: moe-data
          - get: ssh-keys

        - task: task-collate
          input_mapping: { tpen-data: tpen-data-read }

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]

            inputs:
              - name: tpen-data
              - name: moe-data
              - name: ssh-keys
            outputs:
              - name: collatex
              - name: collatex-out
              - name: collatex-out-svg
              - name: collatex-out-pretty
              - name: tpen-data-bumped

            run:
              path: sh
              args:
                - -exc
                - |
                  echo "rearrange data for collatex ..."
                  python3 moe-data/ci/resources/teixml2collatex.py tpen-data/transcription/tei-xml/ collatex --verbose

                  SAVEIFS=$IFS
                  IFS=$(echo -en "\n\b")

                  echo "running collatex ..."
                  sh -c '
                      for IN_FILE in collatex/milestone-*.json
                      do
                          NAME=${IN_FILE##*/}  # strip directory
                          NAME=${NAME%.*}      # strip file ext.

                          OUT_FILE_JSON=collatex-out/$NAME.json
                          OUT_FILE_GRAPHML=collatex-out/$NAME.graphml
                          OUT_FILE_DOT=collatex-out/$NAME.dot
                          SVG_FILE=collatex-out-svg/$NAME.svg

                          # json will be bautified later
                          CMD_COLLATE_JSON="java -jar /root/collatex.jar --tokenized --format json $IN_FILE --output $OUT_FILE_JSON"

                          CMD_COLLATE_GRAPHML="java -jar /root/collatex.jar --tokenized --format graphml $IN_FILE --output $OUT_FILE_GRAPHML"

                          # dot2svg
                          CMD_COLLATE_DOT="java -jar /root/collatex.jar --tokenized --format dot $IN_FILE --output $OUT_FILE_DOT"
                          CMD_SVG="dot -Grankdir=LR -Tsvg $OUT_FILE_DOT -o $SVG_FILE"

                          echo `date -R`: $CMD_COLLATE_JSON
                          $CMD_COLLATE_JSON

                          echo `date -R`: $CMD_COLLATE_GRAPHML
                          $CMD_COLLATE_GRAPHML

                          echo `date -R`: $CMD_COLLATE_DOT
                          $CMD_COLLATE_DOT

                          echo `date -R`: $CMD_SVG
                          $CMD_SVG
                      done
                  '

                  echo `date -R` done

                  echo "pretty print collatex's output ..."
                  python3 moe-data/ci/resources/beautify-json.py collatex-out/ collatex-out-pretty/

                  echo `date -R` done

                  IFS=$SAVEIFS

        - task: task-collatex-to-github
          input_mapping: { tpen-data: tpen-data-read }

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]

            inputs:
              - name: ssh-keys
              - name: collatex-out
            outputs:
              - name: tpen-data-bumped

            run:
              path: sh
              args:
                - -exc
                - |
                  echo "push output of collatex (json and graphml) to github ..."

                  SSH_KEYS_DIR=ssh-keys
                  /bin/chmod 600 ${SSH_KEYS_DIR}/github/DHUniWienMU-id_rsa
                  export GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no -i ssh-keys/github/DHUniWienMU-id_rsa"

                  git clone {{tpen-data-uri}} tpen-data-bumped
                  [ -d tpen-data-bumped/transcription/collatex-out ] || mkdir tpen-data-bumped/transcription/collatex-out/

                  cp -r collatex-out/*json tpen-data-bumped/transcription/collatex-out/
                  cp -r collatex-out/*graphml tpen-data-bumped/transcription/collatex-out/

                  git config --global user.email "ci@dh.gesch.univie.ac.at"
                  git config --global user.name "moe-data/collate"

                  cd tpen-data-bumped/transcription/collatex-out/
                  git add *json *graphml

                  GIT_STATUS=`git status`

                  if echo $GIT_STATUS | grep -q "Changes to be committed:" -;
                  then
                      git commit -m "add output of collatex" *json *graphml
                  fi


        - put: tpen-data-write
          params: {repository: tpen-data-bumped}


        - task: task-collatex-to-webspace

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]

            inputs:
              - name: ssh-keys
              - name: collatex-out-svg

            run:
              path: sh
              args:
                - -exc
                - |
                  echo "copy SVG files to webspace for easy access ..."

                  SSH_KEYS_DIR=ssh-keys
                  /bin/chmod 600 ${SSH_KEYS_DIR}/storage/ci-id_rsa

                  SCP="/usr/bin/scp \
                      -o StrictHostKeyChecking=no \
                      -i ${SSH_KEYS_DIR}/storage/ci-id_rsa"

                  $SCP -r collatex-out-svg/ ci@storage.stemmaweb.net:/home/ci/www/moe-data/

                  echo "SVG files copied to webspace, visit https://www.ci.stemmaweb.net/moe-data/"


    - name: create-stemmarest-instance
      plan:
        - aggregate:
          - get: tpen-data-read
            trigger: true
            passed: [collate]
          - get: ssh-keys
          - get: ci
          - get: moe-config

        - task: task-create-stemmarest-instance
          input_mapping: { tpen-data: tpen-data-read }

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]

            inputs:
              - name: ssh-keys
              - name: ci
              - name: moe-config

            run:
              path: sh
              args:
                - "ci/bin/deploy.sh"
                - "moe-config/deploy-test.conf"


    - name: create-stemmarest-instance-small
      plan:
        - aggregate:
          - get: tpen-data-read
            trigger: true
            passed: [collate]
          - get: ssh-keys
          - get: ci
          - get: moe-config

        - task: task-create-stemmarest-instance-small
          input_mapping: { tpen-data: tpen-data-read }

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]

            inputs:
              - name: ssh-keys
              - name: ci
              - name: moe-config

            run:
              path: sh
              args:
                - "ci/bin/deploy.sh"
                - "moe-config/deploy-test-small.conf"


    - name: feed-the-beast
      plan:
        - aggregate:
          - get: tpen-data-read
            trigger: true
            passed: [create-stemmarest-instance]
          - get: netrc-test-api

        - task: task-feed-the-beast
          input_mapping: { tpen-data: tpen-data-read }

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]


            inputs:
              - name: tpen-data
              - name: netrc-test-api

            #
            # real string interpolation is possible starting with concourse 3.2.0 only
            # {{}} puts the inserted string in quotes
            # starting with 3.2.0 there is the alternative (()) which doesn't
            # therefore values mentioned in pipeline-config.yml.dist are not yet used here
            #
            run:
              path: sh
              args:
                - -exc
                - |
                  # create new user
                  curl \
                      --silent \
                      --insecure \
                      --netrc-file netrc-test-api/dot-netrc \
                      --netrc \
                      --request PUT \
                      --header "Content-Type: application/json" \
                      --data '{ "role":"admin", "id":"alpha", "email":"alpha@dh.gesch", "passphrase":"user-passphrase" }' \
                  https://test.api.stemmaweb.net/moe-data/stemmarest/user/alpha

                  # new tradition
                  curl \
                      --silent \
                      --insecure \
                      --netrc-file netrc-test-api/dot-netrc \
                      --netrc \
                      --request POST \
                      --form "name=MatthewEdessa" \
                      --form "language=armenian" \
                      --form "public=no" \
                      --form "userId=alpha" \
                      --form "empty=no" \
                  https://test.api.stemmaweb.net/moe-data/stemmarest/tradition > create-tradition.response


                  TRADITION_ID=`jq ".tradId" create-tradition.response | sed s/\"//g`

                  SECTION_ID=''

                  # add milestones (sections) to the new tradition
                  for IN_FILE in tpen-data/transcription/collatex-out/milestone-*.graphml
                  do
                      FILE_NAME=${IN_FILE##*/}  # strip directory
                      SECTION_NAME=${FILE_NAME%.*}      # strip file ext.

                      SECTION_ID_PREV=${SECTION_ID}
                      SECTION_ID=''

                      curl \
                          --silent \
                          --insecure \
                          --netrc-file netrc-test-api/dot-netrc \
                          --netrc \
                          --request POST \
                          --form "name=${SECTION_NAME}" \
                          --form "file=@${IN_FILE}" \
                          --form "filetype=collatex" \
                      https://test.api.stemmaweb.net/moe-data/stemmarest/tradition/${TRADITION_ID}/section > create-section.response
                      cat create-section.response

                      SECTION_ID=`jq ".parentId" create-section.response | sed s/\"//g`

                  ### they are already in order
                  #
                  #     # order new milestone (section) right after previous one
                  #     if [ -n ${SECTION_ID_PREV} ]; then
                  #         curl \
                  #             --silent \
                  #             --insecure \
                  #             --netrc-file netrc-test-api/dot-netrc \
                  #             --netrc \
                  #             --request PUT \
                  #         https://test.api.stemmaweb.net/moe-data/stemmarest/tradition/${TRADITION_ID}/section/${SECTION_ID}/orderAfter/${SECTION_ID_PREV}
                  #     fi
                  done

    - name: feed-the-beast-small
      plan:
        - aggregate:
          - get: tpen-data-read
            trigger: true
            passed: [create-stemmarest-instance]
          - get: netrc-test-api

        - task: task-feed-the-beast-small
          input_mapping: { tpen-data: tpen-data-read }

          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: {{tools-image}}
                insecure_registries: [ {{insecure-registries}} ]


            inputs:
              - name: tpen-data
              - name: netrc-test-api

            #
            # real string interpolation is possible starting with concourse 3.2.0 only
            # {{}} puts the inserted string in quotes
            # starting with 3.2.0 there is the alternative (()) which doesn't
            # therefore values mentioned in pipeline-config.yml.dist are not yet used here
            #
            run:
              path: sh
              args:
                - -exc
                - |
                  # create new user
                  curl \
                      --silent \
                      --insecure \
                      --netrc-file netrc-test-api/dot-netrc \
                      --netrc \
                      --request PUT \
                      --header "Content-Type: application/json" \
                      --data '{ "role":"admin", "id":"alpha", "email":"alpha@dh.gesch", "passphrase":"user-passphrase" }' \
                  https://test.api.stemmaweb.net/small-moe-data/stemmarest/user/alpha

                  # new tradition
                  curl \
                      --silent \
                      --insecure \
                      --netrc-file netrc-test-api/dot-netrc \
                      --netrc \
                      --request POST \
                      --form "name=MatthewEdessa" \
                      --form "language=armenian" \
                      --form "public=no" \
                      --form "userId=alpha" \
                      --form "empty=no" \
                  https://test.api.stemmaweb.net/small-moe-data/stemmarest/tradition > create-tradition.response


                  TRADITION_ID=`jq ".tradId" create-tradition.response | sed s/\"//g`

                  SECTION_ID=''

                  # add milestones (sections) to the new tradition
                  for IN_FILE in tpen-data/transcription/collatex-out/milestone-4*.graphml
                  do
                      FILE_NAME=${IN_FILE##*/}  # strip directory
                      SECTION_NAME=${FILE_NAME%.*}      # strip file ext.

                      SECTION_ID_PREV=${SECTION_ID}
                      SECTION_ID=''

                      curl \
                          --silent \
                          --insecure \
                          --netrc-file netrc-test-api/dot-netrc \
                          --netrc \
                          --request POST \
                          --form "name=${SECTION_NAME}" \
                          --form "file=@${IN_FILE}" \
                          --form "filetype=collatex" \
                      https://test.api.stemmaweb.net/small-moe-data/stemmarest/tradition/${TRADITION_ID}/section > create-section.response
                      cat create-section.response

                      SECTION_ID=`jq ".parentId" create-section.response | sed s/\"//g`

                  ### they are already in order
                  #
                  #     # order new milestone (section) right after previous one
                  #     if [ -n ${SECTION_ID_PREV} ]; then
                  #         curl \
                  #             --silent \
                  #             --insecure \
                  #             --netrc-file netrc-test-api/dot-netrc \
                  #             --netrc \
                  #             --request PUT \
                  #         https://test.api.stemmaweb.net/small-moe-data/stemmarest/tradition/${TRADITION_ID}/section/${SECTION_ID}/orderAfter/${SECTION_ID_PREV}
                  #     fi
                  done
